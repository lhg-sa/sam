[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer",
  "enabled": 1,
  "modified": "2025-10-07 20:31:00.249786",
  "module": "SAM",
  "name": "buscar_cui",
  "script": "// Actualizado...\r\nfrappe.ui.form.on('Customer', {\r\n    onload(frm) {\r\n        if (frm.meta.quick_entry) {\r\n            frm.fields_dict.custom_cui__dpi.$input.on('input', function() {\r\n                optimized_dpi_check(frm);\r\n            });\r\n        }\r\n\r\n        attach_uppercase_handlers(frm);\r\n        attach_phone_handler(frm);\r\n\r\n        update_customer_name(frm);\r\n        calculate_age(frm);\r\n\r\n        maybe_check_padron_on_init(frm);\r\n    },\r\n\r\n    onload_post_render(frm) {\r\n        attach_uppercase_handlers(frm);\r\n        attach_phone_handler(frm);\r\n        maybe_check_padron_on_init(frm);\r\n    },\r\n\r\n    refresh(frm) {\r\n        attach_uppercase_handlers(frm);\r\n        attach_phone_handler(frm);\r\n        maybe_check_padron_on_init(frm);\r\n\r\n        // Agregar bot√≥n \"Guardar & Crear\"\r\n        add_save_and_new_button(frm);\r\n    },\r\n\r\n    custom_cui__dpi(frm) {\r\n        if (!frm.doc.custom_cui__dpi) {\r\n            frm._padron_last_query = null;\r\n        }\r\n\r\n        if (!frm.meta.quick_entry) {\r\n            optimized_dpi_check(frm);\r\n            highlight_dpi_validation(frm);\r\n            check_padron_base(frm);\r\n        }\r\n    },\r\n\r\n    custom_nombres(frm) {\r\n        update_customer_name(frm);\r\n    },\r\n    custom_apellidos(frm) {\r\n        update_customer_name(frm);\r\n    },\r\n    custom_apellido_de_casada(frm) {\r\n        update_customer_name(frm);\r\n    },\r\n    apellido_de_casada(frm) {\r\n        update_customer_name(frm);\r\n    },\r\n\r\n    custom_fecha_de_nacimiento(frm) {\r\n        calculate_age(frm);\r\n    },\r\n\r\n    before_save(frm) {\r\n        const fieldsToUpper = [\r\n            'custom_nombres',\r\n            'custom_apellidos',\r\n            'custom_apellido_de_casada',\r\n            'custom_direccion_principal',\r\n            'custom_dpi_extendido_en',\r\n            'custom_lugar_de_nacimiento',\r\n            'custom_ocupacion'\r\n        ];\r\n\r\n        fieldsToUpper.forEach(field => {\r\n            const val = frm.doc[field];\r\n            if (val && typeof val === 'string') {\r\n                frm.set_value(field, val.trim().toUpperCase());\r\n            }\r\n        });\r\n    },\r\n\r\n    validate(frm) {\r\n        if (!cuiIsValid(frm.doc.custom_cui__dpi)) {\r\n            frappe.throw(__('No se puede guardar: El CUI/DPI ingresado es inv√°lido.'));\r\n        }\r\n\r\n        const phone = (frm.doc.custom_telefono_principal || '').trim();\r\n        if (phone && !/^\\d{8}$/.test(phone)) {\r\n            frappe.throw(__('No se puede guardar: El tel√©fono principal debe contener exactamente 8 d√≠gitos num√©ricos.'));\r\n        }\r\n    }\r\n});\r\n\r\n// ---------------- Guardar & Crear Button ----------------\r\nfunction add_save_and_new_button(frm) {\r\n    // Remover bot√≥n anterior si existe para evitar duplicados\r\n    frm.remove_custom_button(__('Guardar & Crear'));\r\n    \r\n    // Agregar el bot√≥n\r\n    frm.add_custom_button(__('Guardar & Crear'), function() {\r\n        frm.save().then(() => {\r\n            frappe.show_alert({\r\n                message: __('Registro guardado exitosamente'),\r\n                indicator: 'green'\r\n            });\r\n            \r\n            // Esperar un momento para que se vea la alerta\r\n            setTimeout(() => {\r\n                frappe.new_doc('Customer');\r\n            }, 500);\r\n        }).catch(err => {\r\n            frappe.msgprint({\r\n                title: __('Error al guardar'),\r\n                message: err.message || __('Ocurri√≥ un error al guardar el registro'),\r\n                indicator: 'red'\r\n            });\r\n        });\r\n    }).addClass('btn-primary');\r\n}\r\n\r\n// ---------------- DPI Validation ----------------\r\nfunction optimized_dpi_check(frm) {\r\n    const raw_value = (frm.doc.custom_cui__dpi || '').trim();\r\n    if (!raw_value) {\r\n        frm._padron_last_query = null;\r\n        return;\r\n    }\r\n\r\n    const dpi_value = raw_value.replace(/\\s+/g, '');\r\n\r\n    if (dpi_value.length >= 11) {\r\n        if (dpi_value.length !== 13) {\r\n            frappe.show_alert({\r\n                message: 'El CUI/DPI debe tener exactamente 13 caracteres (Faltan ' + (13 - dpi_value.length) + ')',\r\n                indicator: 'yellow'\r\n            });\r\n            return;\r\n        }\r\n\r\n        frappe.call({\r\n            method: 'frappe.client.get_list',\r\n            args: {\r\n                doctype: 'Customer',\r\n                filters: { custom_cui__dpi: dpi_value },\r\n                fields: ['name', 'custom_nombres', 'custom_apellidos'],\r\n                limit_page_length: 1\r\n            },\r\n            callback(r) {\r\n                if (r.message && r.message.length > 0) {\r\n                    const customer = r.message[0];\r\n                    frappe.show_alert({\r\n                        message: 'Registro existente encontrado con nombre: ' +\r\n                                 (customer.custom_nombres || '').toUpperCase() + ' ' +\r\n                                 (customer.custom_apellidos || '').toUpperCase(),\r\n                        indicator: 'red'\r\n                    });\r\n                } else {\r\n                    frappe.show_alert({\r\n                        message: 'Registro nuevo v√°lido!',\r\n                        indicator: 'green'\r\n                    });\r\n                }\r\n            }\r\n        });\r\n\r\n        if (cuiIsValid(raw_value)) {\r\n            check_padron_base(frm, dpi_value);\r\n        }\r\n    }\r\n}\r\n\r\n// ---------------- Highlight DPI field ----------------\r\nfunction highlight_dpi_validation(frm) {\r\n    const cui = frm.doc.custom_cui__dpi;\r\n    if (!cui) return;\r\n\r\n    if (!cuiIsValid(cui)) {\r\n        frm.set_df_property('custom_cui__dpi', 'description', '‚ùå CUI inv√°lido');\r\n        frm.fields_dict.custom_cui__dpi.$wrapper.css('border', '2px solid red');\r\n    } else {\r\n        frm.set_df_property('custom_cui__dpi', 'description', '‚úÖ CUI v√°lido');\r\n        frm.fields_dict.custom_cui__dpi.$wrapper.css('border', '2px solid green');\r\n    }\r\n}\r\n\r\n// ---------------- CUI Validation Function ----------------\r\nfunction cuiIsValid(cui) {\r\n    if (!cui) return false;\r\n\r\n    let cuiRegExp = /^[0-9]{4}\\s?[0-9]{5}\\s?[0-9]{4}$/;\r\n    if (!cuiRegExp.test(cui)) return false;\r\n\r\n    cui = cui.replace(/\\s+/g, '');\r\n    let depto = parseInt(cui.substring(9, 11), 10);\r\n    let muni = parseInt(cui.substring(11, 13), 10);\r\n    let numero = cui.substring(0, 8);\r\n    let verificador = parseInt(cui.substring(8, 9), 10);\r\n\r\n    let munisPorDepto = [\r\n        17, 8, 16, 16, 13, 14, 19, 8, 24, 21,\r\n        9, 30, 32, 21, 8, 17, 14, 5, 11, 11,\r\n        7, 17\r\n    ];\r\n\r\n    if (depto === 0 || muni === 0) return false;\r\n    if (depto > munisPorDepto.length) return false;\r\n    if (muni > munisPorDepto[depto - 1]) return false;\r\n\r\n    let total = 0;\r\n    for (let i = 0; i < numero.length; i++) {\r\n        total += numero[i] * (i + 2);\r\n    }\r\n    let modulo = (total % 11);\r\n\r\n    return modulo === verificador;\r\n}\r\n\r\n// ---------------- Concatenate Name Fields ----------------\r\nfunction update_customer_name(frm) {\r\n    const parts = [];\r\n\r\n    if (frm.doc.custom_nombres) parts.push(frm.doc.custom_nombres.toUpperCase());\r\n    if (frm.doc.custom_apellidos) parts.push(frm.doc.custom_apellidos.toUpperCase());\r\n\r\n    const apellidoCasada =\r\n        frm.doc.custom_apellido_de_casada ||\r\n        frm.doc.apellido_de_casada;\r\n\r\n    if (apellidoCasada) parts.push(apellidoCasada.toUpperCase());\r\n\r\n    frm.set_value('customer_name', parts.join(', '));\r\n\r\n    if (frm.doc.custom_nombres && frm.doc.custom_nombres.trim() !== '') {\r\n        frm.set_value('customer_type', 'Individual');\r\n        frm.set_value('customer_group', 'Individual');\r\n    }\r\n}\r\n\r\n// ---------------- Calculate Age ----------------\r\nfunction calculate_age(frm) {\r\n    const birth_date = frm.doc.custom_fecha_de_nacimiento;\r\n    if (!birth_date) {\r\n        frm.set_value('custom_edad', null);\r\n        return;\r\n    }\r\n\r\n    const today = new Date();\r\n    const dob = new Date(birth_date);\r\n    let age = today.getFullYear() - dob.getFullYear();\r\n    const m = today.getMonth() - dob.getMonth();\r\n\r\n    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {\r\n        age--;\r\n    }\r\n\r\n    frm.set_value('custom_edad', age);\r\n}\r\n\r\n// ---------------- Custom Helpers ----------------\r\nfunction attach_uppercase_handlers(frm) {\r\n    const fields = [\r\n        'custom_nombres',\r\n        'custom_apellidos',\r\n        'custom_apellido_de_casada',\r\n        'custom_direccion_principal'\r\n    ];\r\n\r\n    fields.forEach(fieldname => {\r\n        const control = frm.fields_dict[fieldname];\r\n        if (!control || !control.$input) return;\r\n\r\n        control.$input\r\n            .off('blur.forceUppercase')\r\n            .on('blur.forceUppercase', function() {\r\n                const raw = ($(this).val() || '').trim();\r\n                const upper = raw.toUpperCase();\r\n\r\n                if ($(this).val() !== upper) {\r\n                    $(this).val(upper);\r\n                }\r\n\r\n                if (frm.doc[fieldname] !== upper) {\r\n                    frappe.model.set_value(frm.doctype, frm.doc.name, fieldname, upper);\r\n                }\r\n            });\r\n    });\r\n}\r\n\r\nfunction attach_phone_handler(frm) {\r\n    const fieldname = 'custom_telefono_principal';\r\n    const control = frm.fields_dict[fieldname];\r\n    if (!control || !control.$input) return;\r\n\r\n    control.$input\r\n        .attr('inputmode', 'numeric')\r\n        .attr('pattern', '\\\\d*')\r\n        .attr('maxlength', '8')\r\n        .off('input.numericOnly blur.numericOnly')\r\n        .on('input.numericOnly', function() {\r\n            const digits = (this.value || '').replace(/\\D/g, '').slice(0, 8);\r\n            if (this.value !== digits) {\r\n                $(this).val(digits);\r\n            }\r\n        })\r\n        .on('blur.numericOnly', function() {\r\n            const digits = ($(this).val() || '').trim();\r\n\r\n            if (!digits) {\r\n                control.$wrapper.css('border', '');\r\n                frappe.model.set_value(frm.doctype, frm.doc.name, fieldname, '');\r\n                return;\r\n            }\r\n\r\n            if (!/^\\d{8}$/.test(digits)) {\r\n                control.$wrapper.css('border', '2px solid red');\r\n                frappe.show_alert({\r\n                    message: __('El tel√©fono principal debe tener exactamente 8 d√≠gitos.'),\r\n                    indicator: 'red'\r\n                });\r\n            } else {\r\n                control.$wrapper.css('border', '');\r\n            }\r\n\r\n            if (frm.doc[fieldname] !== digits) {\r\n                frappe.model.set_value(frm.doctype, frm.doc.name, fieldname, digits);\r\n            }\r\n        });\r\n}\r\n\r\nfunction maybe_check_padron_on_init(frm) {\r\n    if (frm.is_new()) {\r\n        return;\r\n    }\r\n\r\n    if (frm.doc.custom_cui__dpi && cuiIsValid(frm.doc.custom_cui__dpi)) {\r\n        check_padron_base(frm);\r\n    }\r\n}\r\n\r\n// ---------------- Padron Base Lookup ----------------\r\nfunction check_padron_base(frm, pre_normalized_value) {\r\n    const raw = (typeof pre_normalized_value === 'string' && pre_normalized_value) ||\r\n                (frm.doc.custom_cui__dpi || '');\r\n\r\n    const trimmed = raw.trim();\r\n    const normalized = trimmed.replace(/\\s+/g, '');\r\n\r\n    if (!normalized || normalized.length !== 13) {\r\n        return;\r\n    }\r\n\r\n    if (!cuiIsValid(trimmed)) {\r\n        return;\r\n    }\r\n\r\n    if (frm._padron_last_query === normalized) {\r\n        return;\r\n    }\r\n\r\n    frm._padron_last_query = normalized;\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Padron Base',\r\n            filters: [\r\n                ['Padron Base', 'cui', '=', normalized]\r\n            ],\r\n            fields: [\r\n                'name',\r\n                'primer_nombre',\r\n                'segundo_nombre',\r\n                'tercer_nombre',\r\n                'primer_apellido',\r\n                'segundo_apellido',\r\n                'fecha_nacimiento'\r\n            ],\r\n            limit_page_length: 1\r\n        }\r\n    }).then(r => {\r\n        if (r && Array.isArray(r.message) && r.message.length) {\r\n            const padron = r.message[0] || {};\r\n            const nameParts = [\r\n                padron.primer_nombre,\r\n                padron.segundo_nombre,\r\n                padron.tercer_nombre\r\n            ]\r\n                .map(part => (part || '').trim())\r\n                .filter(Boolean);\r\n\r\n            const surnameParts = [\r\n                padron.primer_apellido,\r\n                padron.segundo_apellido\r\n            ]\r\n                .map(part => (part || '').trim())\r\n                .filter(Boolean);\r\n\r\n            let message = __('Si existe en el padr√≥n');\r\n            if (frm.is_new() && padron.primer_nombre) {\r\n                message = __('Si existe en el padr√≥n. Primer nombre: {0}', [padron.primer_nombre]);\r\n            }\r\n\r\n            if (nameParts.length) {\r\n                const concatenatedNames = nameParts.join(' ').toUpperCase();\r\n                if (concatenatedNames && frm.doc.custom_nombres !== concatenatedNames) {\r\n                    frappe.model.set_value(frm.doctype, frm.doc.name, 'custom_nombres', concatenatedNames);\r\n                }\r\n            }\r\n\r\n            if (surnameParts.length) {\r\n                const concatenatedSurnames = surnameParts.join(' ').toUpperCase();\r\n                if (concatenatedSurnames && frm.doc.custom_apellidos !== concatenatedSurnames) {\r\n                    frappe.model.set_value(frm.doctype, frm.doc.name, 'custom_apellidos', concatenatedSurnames);\r\n                }\r\n            }\r\n\r\n            const birthDateRaw = (padron.fecha_nacimiento || '').trim();\r\n            if (birthDateRaw) {\r\n                let normalizedDate = birthDateRaw;\r\n                if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(birthDateRaw)) {\r\n                    const parsed = new Date(birthDateRaw);\r\n                    if (!isNaN(parsed.getTime())) {\r\n                        normalizedDate = parsed.toISOString().slice(0, 10);\r\n                    }\r\n                }\r\n                if (frm.doc.custom_fecha_de_nacimiento !== normalizedDate) {\r\n                    frappe.model.set_value(frm.doctype, frm.doc.name, 'custom_fecha_de_nacimiento', normalizedDate);\r\n                }\r\n            }\r\n\r\n            frappe.show_alert({\r\n                message,\r\n                indicator: 'green'\r\n            });\r\n        }\r\n    }).catch(err => {\r\n        console.warn('Padron Base lookup error:', err);\r\n        frappe.show_alert({\r\n            message: __('No se pudo consultar el padr√≥n. Revisa la consola para m√°s detalles.'),\r\n            indicator: 'orange'\r\n        });\r\n        frm._padron_last_query = null;\r\n    });\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Estudio Socio Economico",
  "enabled": 1,
  "modified": "2025-10-08 20:14:19.404152",
  "module": "SAM",
  "name": "consulta_dpi",
  "script": "// Script for parent doctype: Estudio Socio Economico (Actualizado)\r\nfrappe.ui.form.on('Estudio Socio Economico', {\r\n    onload: function(frm) {\r\n        // Disable total fields so user can't edit them\r\n        frm.set_df_property('total_ingresos', 'read_only', 1);\r\n        frm.set_df_property('total_gastos', 'read_only', 1);\r\n        frm.set_df_property('diferencia_ingreso_gasto', 'read_only', 1); // üîπ Nuevo\r\n    },\r\n\r\n    cui_dpi: function(frm) {\r\n        // Check if the field exists\r\n        if (!frm.fields_dict['cui_dpi']) {\r\n            frappe.msgprint({\r\n                title: __('Campo no encontrado'),\r\n                message: __('El campo \"cui_dpi\" no existe en este documento.'),\r\n                indicator: 'red'\r\n            });\r\n            return; // Stop execution if field does not exist\r\n        }\r\n\r\n        let search_value = frm.doc.cui_dpi;\r\n        if (!search_value) return; // Exit if empty\r\n\r\n        // Check for duplicates\r\n        frappe.db.get_list('Estudio Socio Economico', {\r\n            filters: { cui_dpi: search_value },\r\n            fields: ['cui_dpi'],\r\n            limit: 1\r\n        }).then(records => {\r\n            if (records.length > 0) {\r\n                frappe.show_alert({\r\n                    message: `El registro ya existe con Id \"${search_value}\" y NO podr√° agregarlo!`,\r\n                    indicator: 'red'\r\n                });\r\n            } else {\r\n                frappe.show_alert({\r\n                    message: `El registro con Id \"${search_value}\". No existe y SI puede ser agregado!`,\r\n                    indicator: 'green'\r\n                });\r\n            }\r\n        });\r\n    },\r\n\r\n    refresh: function(frm) {\r\n        // Recalculate on load/refresh\r\n        calculate_total_ingresos(frm);\r\n        calculate_total_gastos(frm);\r\n        calculate_diferencia(frm); // üîπ Nuevo\r\n\r\n        // Ensure fields remain read-only\r\n        frm.set_df_property('total_ingresos', 'read_only', 1);\r\n        frm.set_df_property('total_gastos', 'read_only', 1);\r\n        frm.set_df_property('diferencia_ingreso_gasto', 'read_only', 1);\r\n\r\n        // Add \"Guardar y Crear\" button\r\n        add_save_and_new_button(frm);\r\n    }\r\n});\r\n\r\n// Script for child doctype: Estudio Socio Economico Ingreso Familia\r\nfrappe.ui.form.on('Estudio Socio Economico Ingreso Familia', {\r\n    nombre_apellido: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        if (row.nombre_apellido) {\r\n            frappe.model.set_value(cdt, cdn, 'nombre_apellido', row.nombre_apellido.toUpperCase());\r\n        }\r\n    },\r\n    ocupacion: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        if (row.ocupacion) {\r\n            frappe.model.set_value(cdt, cdn, 'ocupacion', row.ocupacion.toUpperCase());\r\n        }\r\n    },\r\n    aporte_mensual: function(frm, cdt, cdn) {\r\n        calculate_total_ingresos(frm);\r\n        calculate_diferencia(frm); // üîπ Nuevo\r\n    },\r\n    tabla_ingresos_add: function(frm) {\r\n        calculate_total_ingresos(frm);\r\n        calculate_diferencia(frm); // üîπ Nuevo\r\n    },\r\n    tabla_ingresos_remove: function(frm) {\r\n        calculate_total_ingresos(frm);\r\n        calculate_diferencia(frm); // üîπ Nuevo\r\n    }\r\n});\r\n\r\n// Script for child doctype: Estudio Socio Economico Gasto Familia\r\nfrappe.ui.form.on('Estudio Socio Economico Gasto Familia', {\r\n    monto_gasto: function(frm, cdt, cdn) {\r\n        calculate_total_gastos(frm);\r\n        calculate_diferencia(frm); // üîπ Nuevo\r\n    },\r\n    tabla_gastos_add: function(frm) {\r\n        calculate_total_gastos(frm);\r\n        calculate_diferencia(frm); // üîπ Nuevo\r\n    },\r\n    tabla_gastos_remove: function(frm) {\r\n        calculate_total_gastos(frm);\r\n        calculate_diferencia(frm); // üîπ Nuevo\r\n    }\r\n});\r\n\r\n// -------------------- Helper Functions --------------------\r\n\r\n// Add \"Guardar y Crear\" button\r\nfunction add_save_and_new_button(frm) {\r\n    // Remove previous button to avoid duplicates\r\n    frm.remove_custom_button(__('Guardar y Crear'));\r\n    \r\n    // Add the button\r\n    frm.add_custom_button(__('Guardar y Crear'), function() {\r\n        frm.save().then(() => {\r\n            frappe.show_alert({\r\n                message: __('Registro guardado exitosamente'),\r\n                indicator: 'green'\r\n            });\r\n            \r\n            // Wait a moment for the alert to be visible\r\n            setTimeout(() => {\r\n                frappe.new_doc('Estudio Socio Economico');\r\n            }, 500);\r\n        }).catch(err => {\r\n            frappe.msgprint({\r\n                title: __('Error al guardar'),\r\n                message: err.message || __('Ocurri√≥ un error al guardar el registro'),\r\n                indicator: 'red'\r\n            });\r\n        });\r\n    }).addClass('btn-primary');\r\n}\r\n\r\n// Sum aportes in tabla_ingresos ‚Üí total_ingresos\r\nfunction calculate_total_ingresos(frm) {\r\n    let total = 0;\r\n    (frm.doc.tabla_ingresos || []).forEach(row => {\r\n        total += flt(row.aporte_mensual);\r\n    });\r\n    frm.set_value('total_ingresos', total);\r\n}\r\n\r\n// Sum gastos in tabla_gastos ‚Üí total_gastos\r\nfunction calculate_total_gastos(frm) {\r\n    let total = 0;\r\n    (frm.doc.tabla_gastos || []).forEach(row => {\r\n        total += flt(row.monto_gasto);\r\n    });\r\n    frm.set_value('total_gastos', total);\r\n}\r\n\r\n// üîπ Nuevo: Calcular diferencia entre ingresos y gastos\r\nfunction calculate_diferencia(frm) {\r\n    let ingresos = flt(frm.doc.total_ingresos) || 0;\r\n    let gastos = flt(frm.doc.total_gastos) || 0;\r\n    frm.set_value('diferencia_ingreso_gasto', ingresos - gastos);\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Inscripcion de Programa",
  "enabled": 1,
  "modified": "2025-09-24 12:45:06.797615",
  "module": "SAM",
  "name": "agregar_inscripcion",
  "script": "// Funci√≥n helper para mensajes en la parte superior\r\nfunction top_message(msg, type='success') {\r\n    let color_map = {\r\n        'success': '#28a745',   // verde\r\n        'warning': '#ff9800',   // naranja\r\n        'error': '#dc3545'      // rojo\r\n    };\r\n    let color = color_map[type] || '#28a745';\r\n\r\n    let wrapper = $('<div>')\r\n        .text(msg)\r\n        .css({\r\n            position: 'fixed',\r\n            top: '10px',\r\n            left: '50%',\r\n            transform: 'translateX(-50%)',\r\n            'background-color': color,\r\n            color: 'white',\r\n            padding: '10px 20px',\r\n            'border-radius': '5px',\r\n            'z-index': 9999,\r\n            'box-shadow': '0px 2px 10px rgba(0,0,0,0.3)',\r\n            'font-weight': 'bold'\r\n        });\r\n    $('body').append(wrapper);\r\n    setTimeout(() => { wrapper.fadeOut(500, () => wrapper.remove()); }, 2000); // 2 segundos\r\n}\r\n\r\nfrappe.ui.form.on(\"Inscripcion de Programa\", {\r\n    cui_dpi: function(frm) {\r\n        if (!frm.doc.cui_dpi || frm.doc.cui_dpi.length !== 13 || !/^\\d{13}$/.test(frm.doc.cui_dpi)) return;\r\n\r\n        let parent_doc = frm.doc.programa_o_evento;\r\n\r\n        if (!parent_doc) {\r\n            top_message(__('‚ùå Por favor seleccione un Programa o Evento antes de continuar.'), 'error');\r\n            frm.set_value('cui_dpi', '');\r\n            return;\r\n        }\r\n\r\n        frappe.db.get_value(\"Customer\", { \"custom_cui__dpi\": frm.doc.cui_dpi }, [\"name\", \"customer_name\"])\r\n        .then(r => {\r\n            if (!r || !r.message || !r.message.name) {\r\n                top_message(__('‚ùå Customer no encontrado'), 'error');\r\n                frm.set_value('cui_dpi', '');\r\n                return;\r\n            }\r\n\r\n            let customer_id = r.message.name;\r\n            let customer_name = r.message.customer_name || '';\r\n            let cui_dpi = frm.doc.cui_dpi;\r\n\r\n            top_message(__('‚úÖ Customer encontrado: ' + customer_id), 'success');\r\n\r\n            frappe.db.get_doc(\"Programa Social y Evento\", parent_doc)\r\n            .then(doc => {\r\n                let exists = doc.programa_afiliado.some(d => d.beneficiario_id === customer_id);\r\n                if (exists) {\r\n                    top_message(__('‚ö†Ô∏è Este beneficiario ya est√° inscrito en este programa.'), 'warning');\r\n                    frm.set_value('cui_dpi', '');\r\n                    return;\r\n                }\r\n\r\n                let row = frappe.model.add_child(doc, \"Programa Social y Evento Detalle\", \"programa_afiliado\");\r\n                row.beneficiario_id = customer_id;\r\n                row.customer_name = customer_name;\r\n                row.cui_beneficiario = cui_dpi;\r\n                row.name = parent_doc + \"-\" + customer_id;\r\n                row.doc_link = frm.doc.name;\r\n\r\n                frappe.call({\r\n                    method: \"frappe.client.save\",\r\n                    args: { doc: doc },\r\n                    callback: function(save_res) {\r\n                        if (!save_res.exc) {\r\n                            top_message(__('üéâ Registro agregado correctamente: ' + row.name), 'success');\r\n                            frm.reload_doc();\r\n\r\n                            if (frm.fields_dict.html_inscripcion) {\r\n                                let rows = doc.programa_afiliado.slice(-5);\r\n                                let html = `\r\n                                    <table class=\"table table-bordered table-sm\">\r\n                                        <thead>\r\n                                            <tr>\r\n                                                <th>CUI Beneficiario</th>\r\n                                                <th>Nombre</th>\r\n                                                <th>Fecha Registro</th>\r\n                                            </tr>\r\n                                        </thead>\r\n                                        <tbody>\r\n                                `;\r\n                                rows.forEach(r => {\r\n                                    html += `<tr>\r\n                                                <td>${r.cui_beneficiario || ''}</td>\r\n                                                <td>${r.customer_name || ''}</td>\r\n                                                <td>${frappe.datetime.str_to_user(r.creation || frappe.datetime.now_datetime())}</td>\r\n                                            </tr>`;\r\n                                });\r\n                                html += `</tbody></table>`;\r\n                                frm.fields_dict.html_inscripcion.$wrapper.html(html);\r\n                            }\r\n\r\n                        } else {\r\n                            top_message(__('‚ùå Error al guardar el Programa con el nuevo beneficiario'), 'error');\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n\r\n            frm.set_value('cui_dpi', '');\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Programa Social y Evento",
  "enabled": 1,
  "modified": "2025-09-23 18:37:56.671355",
  "module": "SAM",
  "name": "programa_social",
  "script": "frappe.ui.form.on('Programa Social y Evento', {\r\n    onload: function(frm) {\r\n        // Make doc_link, cui_beneficiario, and customer_name fields in child table read-only\r\n        let child_table_fields = ['doc_link', 'cui_beneficiario', 'customer_name'];\r\n        child_table_fields.forEach(fieldname => {\r\n            let field = frm.fields_dict['programa_afiliado'].grid.get_field(fieldname);\r\n            if(field) {\r\n                field.df.read_only = 1;\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\nfrappe.ui.form.on('Programa Social y Evento Detalle', {\r\n    // Triggered when a new row is added to the child table\r\n    programa_afiliado_add: function(frm, cdt, cdn) {\r\n        let child = frappe.get_doc(cdt, cdn);\r\n        // Set the doc_link to the parent document's name\r\n        child.doc_link = frm.doc.name;\r\n        // Refresh the child table to reflect changes\r\n        frm.refresh_field('programa_afiliado');\r\n    }\r\n});\r\n",
  "view": "Form"
 }
]